Option Explicit

Sub ExtractSupplierTables()
    Dim OutlookApp As Object
    Dim OutlookNamespace As Object
    Dim OutlookFolder As Object
    Dim OutlookMail As Object
    Dim HTMLDoc As Object
    Dim TableElement As Object
    Dim RowElement As Object
    Dim CellElement As Object
    Dim ExcelRow As Long
    Dim ExcelCol As Long
    Dim HeaderText As String
    Dim FoundValid As Boolean
    
    ' Start pasting at row 2
    ExcelRow = 2
    
    ' Connect to Outlook
    Set OutlookApp = CreateObject("Outlook.Application")
    Set OutlookNamespace = OutlookApp.GetNamespace("MAPI")
    
    ' ðŸ“Œ Change folder path as needed
    Set OutlookFolder = OutlookNamespace.Folders("YourEmail@domain.com").Folders("Inbox").Folders("Supplier Replies")
    
    ' Loop through each email
    For Each OutlookMail In OutlookFolder.Items
        If OutlookMail.Class = 43 Then ' 43 = MailItem
            ' Load HTML body
            Set HTMLDoc = CreateObject("HTMLFile")
            HTMLDoc.body.innerHTML = OutlookMail.HTMLBody
            
            FoundValid = False
            
            ' Loop through all tables
            For Each TableElement In HTMLDoc.getElementsByTagName("table")
                
                ' Check for minimum size
                If TableElement.Rows.Length >= 2 And TableElement.Rows(0).Cells.Length >= 3 Then
                    
                    ' Grab header row
                    HeaderText = LCase(Trim(TableElement.Rows(0).innerText))
                    
                    ' âœ… Check if header matches your table
                    If InStr(HeaderText, "field") > 0 _
                       And InStr(HeaderText, "current information") > 0 _
                       And InStr(HeaderText, "changed") > 0 Then
                        
                        ' Found the correct table â†’ copy into Excel
                        For Each RowElement In TableElement.Rows
                            ExcelCol = 1
                            For Each CellElement In RowElement.Cells
                                ThisWorkbook.Sheets(1).Cells(ExcelRow, ExcelCol).Value = Trim(CellElement.innerText)
                                ExcelCol = ExcelCol + 1
                            Next CellElement
                            ExcelRow = ExcelRow + 1
                        Next RowElement
                        
                        ExcelRow = ExcelRow + 1 ' gap between replies
                        FoundValid = True
                        Exit For ' only take first valid table
                    End If
                End If
            Next TableElement
            
            ' If no valid table found, log it
            If Not FoundValid Then
                ThisWorkbook.Sheets(1).Cells(ExcelRow, 1).Value = "âš  No valid table found for: " & OutlookMail.SenderEmailAddress
                ExcelRow = ExcelRow + 2
            End If
        End If
    Next OutlookMail
    
    MsgBox "âœ… Done! All supplier tables extracted to Excel."
End Sub
